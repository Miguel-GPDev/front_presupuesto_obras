<main class="container" [class.login-mode]="vista() === 'login'">
  <header class="top-bar" *ngIf="vista() !== 'login'">
    <h1>Presupuestos de obra</h1>
    <button type="button" (click)="cerrarSesion()">Cerrar sesión</button>
  </header>

  <section *ngIf="vista() === 'login'" class="auth-layout">
    <article class="panel login-panel">
      <h2>{{ authModo() === 'login' ? 'Iniciar sesión' : 'Crear cuenta' }}</h2>
      <p class="muted">Accede para recuperar y enviar presupuestos de obra.</p>

      <div class="auth-switch">
        <button type="button" [class.active]="authModo() === 'login'" (click)="cambiarAuthModo('login')">Login</button>
        <button type="button" [class.active]="authModo() === 'register'" (click)="cambiarAuthModo('register')">Registro</button>
      </div>

      <form *ngIf="authModo() === 'login'" [formGroup]="loginForm" (ngSubmit)="iniciarSesion()" class="login-form">
        <label>
          Email
          <input type="email" formControlName="email" placeholder="usuario@empresa.com" />
        </label>
        <label>
          Contraseña
          <input type="password" formControlName="password" placeholder="********" />
        </label>
        <button type="submit" [disabled]="cargando()">{{ cargando() ? 'Entrando...' : 'Entrar' }}</button>
      </form>

      <form *ngIf="authModo() === 'register'" [formGroup]="registerForm" (ngSubmit)="registrarse()" class="login-form">
        <label>
          Nombre completo
          <input type="text" formControlName="nombre" placeholder="Nombre Apellido" />
        </label>
        <label>
          Email
          <input type="email" formControlName="email" placeholder="usuario@empresa.com" />
        </label>
        <label>
          Contraseña (mínimo 6 caracteres)
          <input type="password" formControlName="password" placeholder="********" />
        </label>
        <button type="submit" [disabled]="cargando()">{{ cargando() ? 'Registrando...' : 'Registrarse' }}</button>
      </form>

      <button type="button" class="quick-btn" (click)="probarRapido()">⚡ Probar rápido (sin login)</button>
      <p class="muted">En modo prueba puedes crear y editar un presupuesto, pero no enviarlo.</p>

      <p class="error" *ngIf="authError()">{{ authError() }}</p>
    </article>
  </section>

  <section *ngIf="vista() === 'home'" class="panel">
    <div class="section-title">
      <div>
        <h2>Mis presupuestos</h2>
        <p class="muted">Usuario: {{ usuarioNombre() }}</p>
      </div>
      <button type="button" (click)="nuevoPresupuesto()">+ Nuevo presupuesto</button>
    </div>

    <button type="button" class="ghost" (click)="cargarPresupuestos()" [disabled]="cargando()">
      {{ cargando() ? 'Actualizando...' : 'Actualizar lista' }}
    </button>

    <ul class="lista-presupuestos" *ngIf="presupuestos().length; else vacio">
      <li *ngFor="let presupuesto of presupuestos()">
        <button type="button" class="item" (click)="abrirPresupuesto(presupuesto.id ?? '')">
          <div>
            <strong>{{ presupuesto.nombre }}</strong>
            <p>{{ presupuesto.descripcion || 'Sin descripción' }}</p>
          </div>
          <span>{{ presupuesto.total | number:'1.2-2' }} €</span>
        </button>
      </li>
    </ul>

    <ng-template #vacio>
      <p class="muted">No tienes presupuestos todavía. Crea el primero.</p>
    </ng-template>
  </section>

  <section *ngIf="vista() === 'editor'" class="panel">
    <div class="section-title">
      <h2>{{ presupuestoActualId() ? 'Editar presupuesto' : 'Nuevo presupuesto' }}</h2>
      <button type="button" class="ghost" (click)="volverAHome()">← Volver a la lista</button>
    </div>

    <p class="preview-pill" *ngIf="!estaAutenticado()">Modo prueba: puedes crear/editar, pero no se enviará al backend.</p>

    <form [formGroup]="form" (ngSubmit)="guardar()">
      <section class="panel nested">
        <h3>Datos generales</h3>
        <div class="grid">
          <label>
            Nombre del presupuesto
            <input formControlName="nombre" placeholder="Ej. Reforma de vivienda" />
          </label>
          <label>
            Descripción
            <textarea formControlName="descripcion" rows="3"></textarea>
          </label>
        </div>
      </section>

      <section class="panel nested" formGroupName="empresa">
        <h3>Empresa emisora</h3>

        <div class="logo-block">
          <input #logoInput type="file" accept="image/*" hidden (change)="onLogoSeleccionado($event)" />
          <button type="button" class="logo-circle" (click)="logoInput.click()" aria-label="Añadir logo">+</button>
          <div class="logo-preview" *ngIf="logoEmpresa()">
            <img [src]="logoEmpresa()" alt="Logo empresa" />
          </div>
          <p class="muted">Añade el logo de la empresa (opcional).</p>
        </div>

        <div class="grid company-grid">
          <label>
            Nombre empresa
            <input formControlName="nombre" placeholder="Constructora Ejemplo S.L." />
          </label>
          <label>
            NIF
            <input formControlName="nif" placeholder="B12345678" />
          </label>
          <label>
            Email
            <input type="email" formControlName="email" placeholder="info@empresa.com" />
          </label>
          <label>
            Teléfono
            <input formControlName="telefono" placeholder="600 000 000" />
          </label>
          <label class="full">
            Dirección
            <input formControlName="direccion" placeholder="Calle, número, CP, ciudad" />
          </label>
        </div>
      </section>

      <section class="panel nested" formGroupName="cliente">
        <h3>Datos del cliente</h3>
        <div class="grid company-grid">
          <label>
            Nombre cliente
            <input formControlName="nombre" placeholder="Cliente Ejemplo" />
          </label>
          <label>
            NIF / DNI
            <input formControlName="nif" placeholder="12345678A" />
          </label>
          <label>
            Email
            <input type="email" formControlName="email" placeholder="cliente@email.com" />
          </label>
          <label>
            Teléfono
            <input formControlName="telefono" placeholder="611 111 111" />
          </label>
          <label class="full">
            Dirección
            <input formControlName="direccion" placeholder="Calle, número, CP, ciudad" />
          </label>
        </div>
      </section>

      <section class="panel nested" formArrayName="capitulos">
        <div class="section-title">
          <h3>Capítulos</h3>
          <button type="button" (click)="agregarCapitulo()">+ Añadir capítulo</button>
        </div>

        <article class="capitulo" *ngFor="let capitulo of capitulos.controls; let i = index" [formGroupName]="i">
          <div class="section-title">
            <h4>Capítulo {{ i + 1 }}</h4>
            <button type="button" class="danger" (click)="eliminarCapitulo(i)">Eliminar capítulo</button>
          </div>

          <div class="grid">
            <label>
              Nombre
              <input formControlName="nombre" />
            </label>
            <label>
              Referencia / Nº
              <input formControlName="referencia" />
            </label>
            <label class="full">
              Descripción
              <textarea formControlName="descripcion" rows="2"></textarea>
            </label>
          </div>

          <div formArrayName="partidas" class="partidas">
            <div class="section-title small">
              <h5>Partidas</h5>
              <button type="button" (click)="agregarPartida(i)">+ Añadir partida</button>
            </div>

            <div class="partida" *ngFor="let partida of partidas(i).controls; let j = index" [formGroupName]="j">
              <label class="descripcion-full">
                Descripción
                <textarea formControlName="descripcion" rows="1" (input)="autoResize($event)"></textarea>
              </label>
              <label>
                Unidad de medida
                <select formControlName="unidadMedida" (change)="actualizarPrecioPorUnidad(i, j)">
                  <option *ngFor="let opcion of opcionesUnidad" [value]="opcion.valor">{{ opcion.etiqueta }}</option>
                </select>
              </label>
              <label>
                Cantidad
                <input type="number" formControlName="cantidad" min="0" step="0.01" />
              </label>
              <label>
                Precio unitario
                <input type="number" formControlName="precio" min="0" step="0.01" />
              </label>
              <div class="total">Total: {{ totalPartida(i, j) | number:'1.2-2' }} €</div>
              <button type="button" class="danger" (click)="eliminarPartida(i, j)">Eliminar</button>
            </div>
          </div>

          <p class="capitulo-total">Total capítulo: {{ totalCapitulo(i) | number:'1.2-2' }} €</p>
        </article>
      </section>

      <section class="panel nested footer">
        <h3>Total presupuesto: {{ totalGeneral() | number:'1.2-2' }} €</h3>

        <div class="actions-row">
          <button type="button" class="ghost" (click)="previsualizarPdf()">Previsualizar PDF</button>
          <button type="submit" [disabled]="guardando()">
            {{ guardando() ? 'Guardando...' : (estaAutenticado() ? 'Guardar y enviar' : 'Guardar borrador local') }}
          </button>
        </div>

        <p class="ok" *ngIf="mensaje()">{{ mensaje() }}</p>
        <p class="error" *ngIf="error()">{{ error() }}</p>
      </section>
    </form>
  </section>

  <p class="error" *ngIf="error() && vista() === 'home'">{{ error() }}</p>
</main>

<section class="preview-modal" *ngIf="mostrandoPreview()">
  <article class="preview-sheet">
    <header class="preview-head">
      <div>
        <h2>{{ form.value.nombre || 'Vista previa de presupuesto' }}</h2>
        <p>{{ form.value.descripcion || 'Sin descripción' }}</p>
      </div>
      <img *ngIf="logoEmpresa()" [src]="logoEmpresa()" alt="Logo empresa" class="preview-logo" />
    </header>

    <div class="preview-grid">
      <section>
        <h3>Empresa emisora</h3>
        <p><strong>{{ form.value.empresa?.nombre || '-' }}</strong></p>
        <p>NIF: {{ form.value.empresa?.nif || '-' }}</p>
        <p>Email: {{ form.value.empresa?.email || '-' }}</p>
        <p>Tel: {{ form.value.empresa?.telefono || '-' }}</p>
        <p>{{ form.value.empresa?.direccion || '-' }}</p>
      </section>
      <section>
        <h3>Cliente</h3>
        <p><strong>{{ form.value.cliente?.nombre || '-' }}</strong></p>
        <p>NIF/DNI: {{ form.value.cliente?.nif || '-' }}</p>
        <p>Email: {{ form.value.cliente?.email || '-' }}</p>
        <p>Tel: {{ form.value.cliente?.telefono || '-' }}</p>
        <p>{{ form.value.cliente?.direccion || '-' }}</p>
      </section>
    </div>

    <section class="preview-capitulos" *ngFor="let capitulo of capitulos.controls; let i = index">
      <h3>{{ capitulo.value.referencia }} - {{ capitulo.value.nombre }}</h3>
      <p>{{ capitulo.value.descripcion }}</p>

      <table>
        <thead>
          <tr>
            <th>Descripción</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let partida of partidas(i).controls; let j = index">
            <td>{{ partida.value.descripcion }}</td>
            <td>{{ partida.value.unidadMedida }}</td>
            <td>{{ partida.value.cantidad }}</td>
            <td>{{ partida.value.precio | number:'1.2-2' }} €</td>
            <td>{{ totalPartida(i, j) | number:'1.2-2' }} €</td>
          </tr>
        </tbody>
      </table>

      <p class="preview-total-cap">Total capítulo: {{ totalCapitulo(i) | number:'1.2-2' }} €</p>
    </section>

    <footer class="preview-footer">
      <strong>Total presupuesto: {{ totalGeneral() | number:'1.2-2' }} €</strong>
      <button type="button" (click)="cerrarPreview()">Cerrar vista previa</button>
    </footer>
  </article>
</section>
